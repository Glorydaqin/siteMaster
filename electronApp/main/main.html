<!DOCTYPE html>
<html>

<head>
    <title>vip share</title>
    <meta charset="utf-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, minimum-scale=1, maximum-scale=1, user-scalable=no">

    <link href="css/bootstrap.min.css?v=3.3.5" rel="stylesheet">
    <link href="css/font-awesome.min.css?v=4.4.0" rel="stylesheet">
    <link href="css/animate.min.css" rel="stylesheet">
    <link href="css/style.min.css?v=4.0.0" rel="stylesheet">

    <link rel="stylesheet" href="../electron-tabs.css">
    <link rel="stylesheet" href="font/iconfont.css">
    <link rel="stylesheet" href="css/main.css">

    <style>
        webview {
            position: absolute;
            visibility: hidden;
            width: 100%;
            height: 100%;
        }

        webview.visible {
            visibility: visible;
        }
    </style>
</head>
<body>

<div style="position: relative">
    <div id="user-center" class="row">

        <div class="user-info col-sm-8">

            <div class="login ibox float-e-margins">

                <div class="ibox-title">
                    <h5>登陆系统</h5>
                </div>
                <div class="ibox-content">
                    <form role="form" class="form-inline">
                        <div class="form-group">
                            <label for="username" class="sr-only">账号</label>
                            <input type="text" placeholder="请输入账号" id="username" class="form-control"
                                   autofocus="autofocus">
                        </div>
                        <div class="form-group">
                            <label for="password" class="sr-only">密码</label>
                            <input type="password" placeholder="请输入密码" id="password" class="form-control">
                        </div>
                        <div class="form-group">
                            <select class="form-control" name="site" id="chooseSite">
                                <option value="0">选择平台</option>
                                <option value="1">Ahrefs</option>
                                <option value="2">Mangools</option>
                            </select>
                        </div>
                        <button class="btn btn-success" type="button" onclick="login()">登录</button>
                    </form>
                </div>
            </div>


            <div class="logout ibox float-e-margins">

                <div class="ibox-title">
                    <h5>用户中心</h5>
                </div>
                <div class="ibox-content">
                    <p>
                        欢迎你: <span class="username"></span> &nbsp;
                        <a class="badge badge-warning" href="javascript:logout()">退出</a>
                    </p>
                    <p>
                        权限剩余：<span class="left_day">30</span>天
                    </p>
                    <p>
                        24小时额度：<span class="limit_map"></span>
                    </p>
                </div>
            </div>
        </div>

        <div class="main col-sm-4">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <h5>选择账号</h5>
                </div>
                <div class="ibox-content no-padding">
                    <ul class="list-group account-list">
                        <li class="list-group-item">
                            <span class="badge badge-primary">切换</span> vip账号1
                        </li>
                    </ul>
                    <!--<p class="text-center">-->
                    <!--<a class="btn btn-sm btn-success btn-outline">-->
                    <!--<i class="fa fa-exchange"></i>翻译中文-->
                    <!--</a>-->
                    <!--<a class="btn btn-sm btn-warning">-->
                    <!--<i class="fa fa-qq"></i>seo交流群-->
                    <!--</a>-->
                    <!--</p>-->
                </div>
            </div>
        </div>

        <div class="col-sm-12">
            <p class="text-center"><a href="javascript:openWithBrowser('https://lypuzi.taobao.com');">点击续费 /
                连续包月联系客服立减3元/月</a></p>
        </div>
    </div>
    <button id="btn-hide">隐藏面板</button>
</div>

<div class="browser">
    <div class="etabs-tabgroup">
        <div class="control-buttons">
            <a class="fa fa-undo" id="btn-fanhui" title="返回"></a>
            <a class="fa fa-refresh" id="btn-shuaxin" title="刷新"></a>
            <a class="fa fa-clone" id="btn-copy" title="复制"></a>
        </div>
        <div class="etabs-tabs"></div>
        <div class="etabs-buttons"></div>
    </div>
    <div class="etabs-views"></div>

    <div class="cover">
        请先登录选择账号
    </div>
</div>

<style type="text/css">
    .upgrade-box {
        position: fixed;
        bottom: 0;
        width: 100%;
        height: auto;
        background: #ffffff;
        z-index: 100;
    }

    .upgrade-box > div {
        float: right;
        vertical-align: middle;
        margin: 5px !important;
    }

    .upgrade-box .loading {

    }


    .upgrade-box .upgrade {
        display: none;
    }
</style>

<div class="upgrade-box">

    <div class="loading">
        <div class="sk-spinner sk-spinner-circle">
            <div class="sk-circle1 sk-circle"></div>
            <div class="sk-circle2 sk-circle"></div>
            <div class="sk-circle3 sk-circle"></div>
            <div class="sk-circle4 sk-circle"></div>
            <div class="sk-circle5 sk-circle"></div>
            <div class="sk-circle6 sk-circle"></div>
            <div class="sk-circle7 sk-circle"></div>
            <div class="sk-circle8 sk-circle"></div>
            <div class="sk-circle9 sk-circle"></div>
            <div class="sk-circle10 sk-circle"></div>
            <div class="sk-circle11 sk-circle"></div>
            <div class="sk-circle12 sk-circle"></div>
        </div>
    </div>

    <div class="upgrade">
        可升级到<span class="version">v1.0.0</span>
        <a href="javascript:openUpgradeInfo();">（新版功能）</a>
        <button class="btn btn-danger" id="upgrade-btn">升级</button>
        <button class="btn btn-default" id="upgrade-cancel-btn" onclick="$('.upgrade-box').hide();">取消</button>
    </div>

</div>


<script>window.$ = window.jQuery = require("./js/jquery.min");</script>
<script src="js/bootstrap.min.js?v=3.3.5"></script>
<script src="js/layer-v3.1.1/layer.js"></script>
<script src="js/common.js"></script>
<script src="main.js"></script>
<script>
    const https = require('https');
    const os = require("os");
    const fs = require('fs');

    // console.log(versionObj)
    // 禁止页面刷新
    window.onkeydown = function (e) {
        var ev = window.event || e;
        var code = ev.keyCode || ev.which;
        if (code === 82 && (ev.metaKey || ev.ctrlKey)) {
            console.log('flush def')
            return false;
        }
    }

    //检查更新
    // console.log(process)
    // var upgradeInfo = [];
    var latestVersion = [];
    $.ajax({
        type: "GET",//使用get请求请求正确
        url: apiHost + "/app/version.json",
        dataType: "json",
        cache: false,
        //data:
        success: function (data) {
            console.log("data: " + JSON.stringify(data))

            if (version !== data.version) {
                // 版号不一致. 弹出更新弹框
                $(".version").text('v' + data.version)
                latestVersion = data['version-list'][0];
                // upgradeInfo = data['version-list'][0].info;

                $(".upgrade-box .loading").hide();
                $(".upgrade-box .upgrade").show();
            } else {
                $(".upgrade-box .loading").text('已是最新版本');
                setTimeout(function () {
                    $(".upgrade-box").hide();
                }, 1500)
            }
        },
        error: function () {
            $(".upgrade-box .loading").text('检查更新失败');
            setTimeout(function () {
                $(".upgrade-box").hide();
            }, 1500)
        }
    })

    function openUpgradeInfo() {
        parent.layer.alert(latestVersion.info.join("</br>"), {
            skin: 'layui-layer-molv', //样式类名
            // anim: 5,
            // closeBtn:1,
            // title:'信息',
        });
    }

    function calculate_percent(now, all) {
        console.log(now / all * 100 + '%');
    }

    var allBytes = 0;
    var nowBytes = 0;
    var getHttpsData = function (url, success, error) {
        // 回调缺省时候的处理
        success = success || function () {
        };
        error = error || function () {
        };

        https.get(url, function (res) {
            console.log(res)
            allBytes = res.headers['content-length'];
            var statusCode = res.statusCode;

            if (statusCode !== 200) {
                // 出错回调
                error();
                // 消耗响应数据以释放内存
                res.resume();
                return;
            }

            res.setEncoding('utf8');
            var rawData = '';
            res.on('data', function (chunk) {
                rawData += chunk;
                nowBytes = rawData.length;
                calculate_percent(nowBytes, allBytes);
            });

            // 请求结束
            res.on('end', function () {
                // 成功回调
                success(rawData);
            }).on('error', function (e) {
                // 出错回调
                error();
            });
        });
    };

    $('#upgrade-btn').click(function () {


        console.log(os.tmpdir());
        console.log(os.type());
        console.log(latestVersion)
        var fileUrl = (os.type() === 'Darwin') ? latestVersion['file-mac'] : latestVersion['file-win'];
        var tmpFile = fileUrl.split("/")[fileUrl.split("/").length - 1];

        // os.type(); // Linux, Darwin or Window_NT
        // os.platform(); // 'darwin', 'freebsd', 'linux', 'sunos' or 'win32'

        console.log(tmpFile)
        getHttpsData(fileUrl, function (data) {
            // 写入文件

            console.log(tmpFile);
            fs.writeFileSync(os.tmpdir() + '/' + tmpFile, data);
            // 然后下一个文件获取并写入...
            console.log('write success')
        }, function () {
            console.log('文件下载异常，请检查网络')
        });

    })


</script>
</body>
</html>
